<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Stranger Things Wall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<h1>Stranger Things Nachricht</h1>

<p>Status: <span id="status">Getrennt</span></p>

<form id="msgForm">
    <input id="messageInput" type="text" placeholder="Nachricht eingeben" required>
    <button type="submit">Senden</button>
</form>

<pre id="log"></pre>

<!-- MQTT.js aus CDN laden -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const form = document.getElementById('msgForm');
    const input = document.getElementById('messageInput');

    function log(msg) {
        console.log(msg);
        logEl.textContent += msg + '\n';
    }

    // HIER deine HiveMQ-Daten einsetzen
    const host = 'b2d8ace7b2de4ec6aae81f8deb1b637c.s1.eu.hivemq.cloud';
    const port = 8884; // WebSocket + TLS
    const topic = 'strangerthings/wall'; // genau diesen Topic auch im ESP32 verwenden

    const connectUrl = `wss://${host}:${port}/mqtt`;

    const options = {
        username: 'Pablo',       // wie im HiveMQ-Account eingerichtet
        password: 'Wimsheim1',  // wie im HiveMQ-Account eingerichtet
        clientId: 'pkern_' + Math.random().toString(16).slice(2, 10),
        clean: true,
        connectTimeout: 15000,
        reconnectPeriod: 5000
    };

    log('Verbinde zu: ' + connectUrl);

    const client = mqtt.connect(connectUrl, options);

    client.on('connect', () => {
        statusEl.textContent = 'Verbunden';
        statusEl.style.color = 'green';
        log('Mit HiveMQ Cloud verbunden.');

        // Optional: Topic abonnieren, um eigene Nachrichten zu sehen
        client.subscribe(topic, (err) => {
            if (err) {
                log('Subscribe-Fehler: ' + err.message);
            } else {
                log('Subscribed auf Topic: ' + topic);
            }
        });
    });

    client.on('reconnect', () => {
        statusEl.textContent = 'Verbinde neu…';
        statusEl.style.color = 'orange';
        log('Versuche, die Verbindung wiederherzustellen…');
    });

    client.on('close', () => {
        statusEl.textContent = 'Getrennt';
        statusEl.style.color = 'red';
        log('Verbindung geschlossen.');
    });

    client.on('error', (err) => {
        statusEl.textContent = 'Fehler';
        statusEl.style.color = 'red';
        log('Fehler: ' + err.message);
    });

    client.on('message', (topic, payload) => {
        log(`Nachricht empfangen [${topic}]: ${payload.toString()}`);
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const msg = input.value.trim();
        if (!msg) return;

        if (!client.connected) {
            log('Nicht verbunden – Nachricht nicht gesendet.');
            return;
        }

        client.publish(topic, msg, { qos: 0, retain: false }, (err) => {
            if (err) {
                log('Publish-Fehler: ' + err.message);
            } else {
                log('Gesendet: ' + msg);
                input.value = '';
            }
        });
    });
</script>
</body>
</html>
